@{
    ViewBag.Title = "Nota de Evolución";
}

<style>
    .nav-tabs.nav-tabs-bottom > li {
        margin-bottom: -1px;
        width: 110px;
        max-width: 110px;
        font-size: 10px;
    }

    .user-tabs .nav-tabs > li > a {
        padding: 5px;
    }


    .diaginfo {
        position: absolute;
        top: 0;
        left: 0;
        padding: 2px 15px;
        background-color: #FBC43D;
        color: white;
        margin-left: -20px;
        font-size: 15px;
        font-weight: bolder;
    }

        .diaginfo:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 0;
            height: 0;
            border-top: solid 30px #FBC43D;
            border-left: solid 50px transparent;
            border-right: solid 50px transparent;
        }


    .diaginfo2 {
        position: absolute;
        top: 0;
        left: 0;
        padding: 2px 15px;
        background-color: #FBC43D;
        color: white;
        margin-left: -20px;
        margin-top: -40px;
        font-size: 12px;
        font-weight: bolder;
    }

        .diaginfo2:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 0;
            height: 0;
            border-top: solid 20px #FBC43D;
            border-left: solid 20px transparent;
            border-right: solid 20px transparent;
        }

    .resumenTop {
        position: absolute;
        top: 0;
        left: 0;
        width: 2.5vw;
        height: 2.5vw;
        border-radius: 2.5vw;
        background-color: #FBC43D;
        color: white;
        font-size: 1.2vw;
        line-height: 2.5vw;
        text-align: center;
    }


    .resumenTopCheck {
        position: absolute;
        top: 0;
        right: 0;
        width: 1.5vw;
        height: 1.5vw;
        border-radius: 100%;
        background-color: #FBC43D;
        color: white;
        font-size: 0.8vw;
        line-height: 1.5vw;
        text-align: center;
    }

    .resumenText {
        font-size: 0.8vw;
        margin-top: 3vw;
        color: #9E9E9E;
        font-weight: bolder;
        -moz-box-shadow: none !important;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        border: none;
        font-weight: bold;
        border-bottom: 2px solid #FBC43D;
        outline-width: 0;
        width: 100%;
        max-width: 100%;
        background-color: transparent;
    }

    .tipoconsulta {
        border-radius: 0px;
        border: 2px solid #FBC43D;
    }

    .borrardiag {
        width: 100%;
        filter: grayscale(100%);
    }

    .borrarInt {
        width: 50px;
        filter: grayscale(100%);
    }
</style>

<div class="page-wrapper">
    <div class="content container-fluid">

        <div class="page-header">
            <div class="row">
                <div class="col-sm-12">
                    <h3 class="page-title">Nota de Evolución</h3>
                    @*<ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="@Url.Action(" Index", "Admin" )">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="@Url.Action(" Index", "HistoriaClinica" )">Historia Clínica</a></li>
                        </ul>*@
                </div>
            </div>
        </div>

        <div class="row">

            <div class="col-sm-12" id="InfoPX">
                <div class="profile-header">
                    <div class="row align-items-center">
                        <div class="col-auto profile-image">
                            <a href="#">
                                @*<img class="rounded-circle" alt="User Image" src="~/Content/assets/img/profiles/avatar-04.jpg">*@
                            </a>
                        </div>
                        <div class="col ml-md-n2 profile-user-info">
                            <h10 style="font-weight:bold;">Nombre: </h10>
                            <a id="Nombre"></a><br />
                            <h10 style="font-weight:bold;">Expediente: </h10>
                            <a id="Exp"></a><br />
                            <h10 style="font-weight:bold;">Edad: </h10>
                            <a id="Edad"></a><br />
                            <h10 style="font-weight:bold;">Sexo: </h10>
                            <a id="Sexo"></a><br />
                            <h10 style="font-weight:bold;">Fecha Nac.: </h10>
                            <a id="FechaNac"></a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12" id="BusquedaPX">
                <div class="row">
                    <div class="col-md-12">
                        <h4>Busque al px.</h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <input type="text" class="form-control BuscarPX" id="NombrePX" placeholder="Nombre PX" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <input type="text" class="form-control BuscarPX" id="ExpedientePX" placeholder="Expediente PX" required>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-primary" onclick="BtnBuscarPX()">Buscar</button>
                    </div>
                </div>
                <div>
                    <div class="table-responsive">
                        <table id="TblPaciente" class="datatable table table-stripped">
                            <thead>
                                <tr>
                                    <th style="text-align:center">
                                        Nombre
                                    </th>
                                    <th style="text-align:center">
                                        Primer Apellido
                                    </th>
                                    <th style="text-align:center">
                                        Segundo Apellido
                                    </th>
                                    <th style="text-align:center">
                                        Unidad de Afiliacion
                                    </th>
                                    <th style="text-align:center">
                                        Expediente
                                    </th>
                                    <th style="width:5px">Seleccionar</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-sm-12">

                <div class="row m-0 ml-3 mr-3">
                    <div class="col-12 p-2">
                        <div class="resumenTop" id="subjetivoLetra">S</div>
                        <div class="resumenTopCheck" id="subjetivoCheck">✓</div>
                        <textarea class="resumenText mt-5" id="subjetivo" name="s_exp"></textarea>
                    </div>
                    <div class="col-12 p-2">
                        <div class="resumenTop" id="objetivoLetra">O</div>
                        <div class="resumenTopCheck" id="objetivoCheck">✓</div>
                        <textarea class="resumenText mt-5" id="objetivo" name="o_exp"></textarea>
                    </div>
                    <div class="col-12 p-2">
                        <div class="resumenTop" id="analisisLetra">A</div>
                        <div class="resumenTopCheck" id="analisisCheck">✓</div>
                        <div class="row mt-5 ml-0 mr-0 mb-0" id="diagnosticoMedico">
                            <div class="col-md-12 p-2 text-left">
                                <h6>Mis diagnósticos frecuentes <img class="flecha" src="~/Imagenes/iconos/flecha-abajo.png" /> </h6>
                            </div>
                        </div>
                        <div class="row m-0 mt-5" id="diagnosticoPaciente">
                            <div class="col-md-12 p-2 text-left">
                                <h6>Diagnósticos frecuentes del paciente <img class="flecha" src="~/Imagenes/iconos/flecha-abajo.png" /> </h6>
                            </div>
                        </div>
                        <div class="row m-0 mt-5" id="diagnosticoEspecialidad">
                            <div class="col-md-12 p-2 text-left">
                                <h6>Diagnósticos frecuentes de especialidad <img class="flecha" src="~/Imagenes/iconos/flecha-abajo.png" /> </h6>
                            </div>
                        </div>
                        <div class="row m-0 mt-5" id="diagnosticoBusqueda">
                            <div class="col-md-12 p-2 text-left">
                                <h6>Buscar otro diagnostico</h6>
                                <input style="width:90%;" id="diagnosticoTxt" placeholder="Escribe aquí la descripción o clave y da clic en el boton de buscar" />
                                <a class="btn btn-buscar">
                                    <img src="~/Imagenes/search1.png" class="btnbuscapac">
                                </a>
                            </div>
                        </div>

                        <div class="row m-0 mt-5" id="diagnosticoBusquedaLista"></div>
                        <p style="color:red;" id="diagnosticoBusquedaAlert"></p>
                        <div class="row m-0 mt-5" id="diagnosticoBusquedaListaHistorial"></div>


                        <div class="row m-0">
                            <div class="col-md-12 p-2">
                                <div class="diaginfo">1. Diagnóstico</div>
                            </div>

                            <div class="col-md-9 m-auto p-2">
                                <textarea class="resumenText" id="diagnostico1" name="diagnostico" readonly></textarea>
                                <input id="clave1" type="hidden" />
                            </div>
                            <div class="col-md-3 m-auto p-0">
                                <div class="row m-0">
                                    <div class="col-md-12 p-2">
                                        <div class="diaginfo2" id="diaginfo1">Selecciona el tipo de diagnostico antes de seleccionar otro</div>
                                    </div>
                                    <div class="col-9 p-2">
                                        <select class="form-control tipoconsulta" id="tipoconsulta1" name="tipconsulta" required>
                                            <option disabled selected>Seleccionar opción</option>
                                            <option value="2">Subsecuente</option>
                                            <option value="1">Primera Vez</option>
                                        </select>
                                    </div>
                                    <div class="col-3 p-2">
                                        <img class="borrardiag" id="borrardiag1" src="~/Imagenes/iconos/trashcan2.png" />
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="row m-0">
                            <div class="col-md-12 p-2">
                                <div class="diaginfo">2. Diagnóstico</div>
                            </div>

                            <div class="col-md-9 m-auto p-2">
                                <textarea class="resumenText" id="diagnostico2" name="diagnostico2" readonly></textarea>
                                <input id="clave2" type="hidden" />
                            </div>
                            <div class="col-md-3 m-auto p-0">
                                <div class="row m-0">
                                    <div class="col-md-12 p-2">
                                        <div class="diaginfo2" id="diaginfo2">Selecciona el tipo de diagnostico antes de seleccionar otro</div>
                                    </div>
                                    <div class="col-9 p-2">
                                        <select class="form-control tipoconsulta" id="tipoconsulta2" name="tipconsulta" required>
                                            <option disabled selected>Seleccionar opción</option>
                                            <option value="2">Subsecuente</option>
                                            <option value="1">Primera Vez</option>
                                        </select>
                                    </div>
                                    <div class="col-3 p-2">
                                        <img class="borrardiag" id="borrardiag2" src="~/Imagenes/iconos/trashcan2.png" />
                                    </div>
                                </div>
                            </div>
                        </div>


                        <div class="row m-0">
                            <div class="col-md-12 p-2">
                                <div class="diaginfo">3. Diagnóstico</div>
                            </div>

                            <div class="col-md-9 m-auto p-2">
                                <textarea class="resumenText" id="diagnostico3" name="diagnostico3" readonly></textarea>
                                <input id="clave3" type="hidden" />
                            </div>
                            <div class="col-md-3 m-auto p-0">
                                <div class="row m-0">
                                    <div class="col-9 p-2">
                                        <select class="form-control tipoconsulta" id="tipoconsulta3" name="tipconsulta" required>
                                            <option disabled selected>Seleccionar opción</option>
                                            <option value="2">Subsecuente</option>
                                            <option value="1">Primera Vez</option>
                                        </select>
                                    </div>
                                    <div class="col-3 p-2">
                                        <img class="borrardiag" id="borrardiag3" src="~/Imagenes/iconos/trashcan2.png" />
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                    <div class="col-12 p-2">
                        <div class="resumenTop" id="planLetra">P</div>
                        <div class="resumenTopCheck" id="planCheck">✓</div>
                        <textarea class="resumenText mt-5" id="plan" name="p_exp"></textarea>
                    </div>
                    <div class="col-md-12 p-2 mt-4 ml-2">
                        <div class="form-check p-0">
                            @Html.CheckBox("interCheck", false, htmlAttributes: new { id = "interCheck", @class = "form-check-input" })
                            <label class="form-check-label ml-2" for="interCheck"><h6><b>Interconsultas</b></h6> </label>
                        </div>
                    </div>
                    <div class="col-md-12 p-0" id="interconsultaInfo">

                        <div class="row m-0">
                            <div class="col-md-12 p-2">
                                <div class="diaginfo">1. Interconsulta</div>
                                <div class="row m-0 mt-3">
                                    <div class="col-9 p-0">
                                        <select class="form-control" name="referido" id="referido">
                                            <option id="referidoSeleccionar" value="0" selected disabled>Seleccionar especialidad</option>
                                        </select>
                                        <select class="form-control" name="subreferido" id="subreferido">
                                            <option id="subreferidoSeleccionar" value="0" selected disabled>Seleccionar subcategoria</option>

                                        </select>
                                        <select class="form-control" name="medicoreferido" id="medicoreferido">
                                            <option id="medicoreferidoSeleccionar" value="0" selected disabled>Seleccionar médico</option>
                                        </select>
                                    </div>
                                    <div class="col-2 p-0 m-auto pl-4">
                                        <div class="form-check p-0">
                                            @Html.CheckBox("urgenciaCheck", false, htmlAttributes: new { id = "urgenciaCheck", @class = "form-check-input" })
                                            <label class="form-check-label ml-2" for="urgenciaCheck"><h6><b>Urgencia</b></h6> </label>
                                        </div>
                                    </div>
                                    <div class="col-1 p-2">
                                        <img class="borrarInt" id="borrarInt1" src="~/Imagenes/iconos/trashcan2.png">
                                    </div>
                                    <div class="col-md-12 p-0">
                                        <textarea class="form-control mb-3" name="ref_exp" id="ref_exp" placeholder="Observaciones"></textarea>
                                    </div>


                                </div>

                            </div>

                                <div class="col-md-12 p-2">
                                    <div class="diaginfo">2. Interconsulta</div>
                                    <div class="row m-0 mt-3">
                                        <div class="col-9 p-0">
                                            <select class="form-control" name="referido2" id="referido2" disabled>
                                                <option id="referidoSeleccionar2" value="0" selected disabled>Seleccionar especialidad</option>
                                            </select>
                                            <select class="form-control" name="subreferido2" id="subreferido2">
                                                <option id="subreferidoSeleccionar2" value="0" selected disabled>Seleccionar subcategoria</option>

                                            </select>
                                            <select class="form-control" name="medicoreferido2" id="medicoreferido2">
                                                <option id="medicoreferidoSeleccionar2" value="0" selected disabled>Seleccionar médico</option>
                                            </select>
                                        </div>
                                        <div class="col-2 p-0 m-auto pl-4">
                                            <div class="form-check p-0">
                                                @Html.CheckBox("urgenciaCheck2", false, htmlAttributes: new { id = "urgenciaCheck2", @class = "form-check-input", @disabled = "disabled" })
                                                <label class="form-check-label ml-2" for="urgenciaCheck2"><h6><b>Urgencia</b></h6> </label>
                                            </div>
                                        </div>
                                        <div class="col-1 p-2">
                                            <img class="borrarInt" id="borrarInt2" src="~/Imagenes/iconos/trashcan2.png">
                                        </div>
                                        <div class="col-md-12 p-0">
                                            <textarea class="form-control mb-3" name="ref_exp2" id="ref_exp2" placeholder="Observaciones" disabled></textarea>
                                        </div>
                                    </div>
                                </div>



                                <div class="col-md-12 p-2">
                                    <div class="diaginfo">3. Interconsulta</div>
                                    <div class="row m-0 mt-3">
                                        <div class="col-9 p-0">
                                            <select class="form-control" name="referido3" id="referido3" disabled>
                                                <option id="referidoSeleccionar" value="0" selected disabled>Seleccionar especialidad</option>
                                            </select>
                                            <select class="form-control" name="subreferido3" id="subreferido3">
                                                <option id="subreferidoSeleccionar3" value="0" selected disabled>Seleccionar subcategoria</option>

                                            </select>
                                            <select class="form-control" name="medicoreferido3" id="medicoreferido3">
                                                <option id="medicoreferidoSeleccionar3" value="0" selected disabled>Seleccionar médico</option>
                                            </select>
                                        </div>
                                        <div class="col-2 p-0 m-auto pl-4">
                                            <div class="form-check p-0">
                                                @Html.CheckBox("urgenciaCheck3", false, htmlAttributes: new { id = "urgenciaCheck3", @class = "form-check-input", @disabled = "disabled" })
                                                <label class="form-check-label ml-2" for="urgenciaCheck3"><h6><b>Urgencia</b></h6> </label>
                                            </div>
                                        </div>
                                        <div class="col-1 p-2">
                                            <img class="borrarInt" id="borrarInt3" src="~/Imagenes/iconos/trashcan2.png">
                                        </div>
                                        <div class="col-md-12 p-0">
                                            <textarea class="form-control mb-3" name="ref_exp3" id="ref_exp3" placeholder="Observaciones" disabled></textarea>
                                        </div>
                                    </div>
                                </div>

                        </div>

                    </div>
                </div>
                <div class="col-md-12 mt-4 text-center">
                    <button type="submit" name="next" class="next success-button" id="finalizar">Finalizar</button>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="~/Areas/Admin/assets/js/jquery-3.2.1.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>

    //$(document).ready(function () {
        $("#InfoPX").hide();

        //Si dan click en Enter en los inputs de Nombre/Expediente
        $('.BuscarPX').on("keypress", function (e) {
            if (e.keyCode == 13) {
                FuncionBuscarPX();
                return false;
            }
        });

        //Si dan click en el botón de Buscar
        function BtnBuscarPX() {
            //alert('adad');
            FuncionBuscarPX();
        };

        function FuncionBuscarPX() {
            var NombrePX = $("#NombrePX").val();
            var ExpedientePX = $("#ExpedientePX").val();

            Swal.fire({
                title: 'Cargando... Espere por favor',
                timer: 1000,
                timerProgressBar: true,
            });

            $.ajax({
                url: '@Url.Action("BuscarPaciente", "Derechohabiente")',
                method: 'POST',
                dataType: 'json',
                data: {
                    NombrePX: NombrePX,
                    ExpedientePX: ExpedientePX
                },
                success: function (data) {
                    if (data.MENSAJE.substring(0, 6) == "Succe:") {
                        LlenaTablaPX(data.PACIENTES);
                    }
                    if (data.MENSAJE.substring(0, 6) == "Error:") {
                        Swal.fire({
                            icon: 'error',
                            title: '¡Error!',
                            text: data.MENSAJE.substring(7),
                        });
                    }
                },
                error: function (ex) {
                    Swal.fire({
                        icon: 'error',
                        title: '¡Error!',
                    });
                }
            });

        };

        function LlenaTablaPX(PX) {
            var table = $('#TblPaciente').DataTable();
            table.destroy();

            table = $('#TblPaciente').DataTable({
                responsive: true,
                searching: false,
                info: true,
                deferRender: true,
                scroller: false,
                scrollColapse: true,
                paging: false,
                lengthChange: false,
                language: {
                    "zeroRecords": "No se encontraron PX",
                    "info": "",
                    "search": "",
                    "infoEmpty": "",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior",
                    },
                    "select": {
                        "rows": " %d filas seleccionadas"
                    },
                },
                data: PX,
                columns: [
                    { 'data': 'Nombre', className: "text-center" },
                    { 'data': 'PrimerApellido', className: "text-center" },
                    { 'data': 'SegundoApellido', className: "text-center" },
                    {
                        "data": "UnidadAfiliacion", className: "text-center", render: function (data, type, row) {
                            if (row.UnidadAfiliacion == 1) {
                                return '<h8 style="color:black; ">Unidad habitacional I.</h8>';
                            }
                            if (row.UnidadAfiliacion == 2) {
                                return '<h8 style="color:black; ">Módulo dental Apodaca</h8>';
                            }
                            if (row.UnidadAfiliacion == 3) {
                                return '<h8 style="color:black; ">Pueblo Nuevo</h8>';
                            }
                            if (row.UnidadAfiliacion == 4) {
                                return '<h8 style="color:black; ">Vicente Guerrero</h8>';
                            }
                            if (row.UnidadAfiliacion == 5) {
                                return '<h8 style="color:black; ">San Rafael</h8>';
                            }
                            if (row.UnidadAfiliacion == 6) {
                                return '<h8 style="color:black; ">21 de enero</h8>';
                            }
                            if (row.UnidadAfiliacion == 7) {
                                return '<h8 style="color:black; ">Clínica de atención int.</h8>';
                            }
                            if (row.UnidadAfiliacion == 8) {
                                return '<h8 style="color:black; ">Módulo dental Guadalupe</h8>';
                            }
                            if (row.UnidadAfiliacion == 9) {
                                return '<h8 style="color:black; ">Ciénega de Flores</h8>';
                            }
                        }
                    },
                    { 'data': 'Expediente', className: "text-center" },
                    {
                        "className": 'text-center',
                        "orderable": false,
                        "data": null,
                        "defaultContent": '<button title="Seleccionar px" id="VerDetalle" class="btn btn-success fa fa-check" data-toggle="modal" ></button>',
                        "target": -2
                    }
                ]
            });
        }


        $('#TblPaciente tbody').on('click', '#VerDetalle', function () {
            var tr = $(this).closest('tr');
            row = $('#TblPaciente').DataTable().row(tr);

            var Nombre = row.data().Nombre;
            var PrimerA = row.data().PrimerApellido;
            var SegundoA = row.data().SegundoApellido;
            var Exp = row.data().Expediente;
            var Edad = row.data().Edad;
            var Sexo = row.data().Sexo;
            var FechaN = row.data().FechaNacimiento;

            //console.log(FechaN);
            //Dividir fecha de nacimiento
            var splitFechaN = FechaN.split('/');
            const anioNacimiento = parseInt(splitFechaN[2]);
            const mesNacimiento = parseInt(splitFechaN[1]);
            const diaNacimiento = parseInt(splitFechaN[0]);

            // Obtiene la fecha actual
            const fechaActual = new Date();

            // Obtiene el año, mes y día actual
            const anioActual = fechaActual.getFullYear();
            const mesActual = fechaActual.getMonth() + 1; // Los meses en JavaScript van de 0 a 11
            const diaActual = fechaActual.getDate();

            // Calcula la edad
            let edad = anioActual - anioNacimiento;
            let edadMeses = mesActual - mesNacimiento;

            // Verifica si aún no ha llegado el cumpleaños de este año
            if (mesActual < mesNacimiento || (mesActual === mesNacimiento && diaActual < diaNacimiento)) {
                edad--;
            }

            //alert(edad + mesActual);

            document.getElementById("Nombre").innerHTML = Nombre + " " + PrimerA + " " + SegundoA;
            document.getElementById("Exp").innerHTML = Exp;
            document.getElementById("Edad").innerHTML = edad + ' años ' + edadMeses + ' meses';
            document.getElementById("Sexo").innerHTML = Sexo;
            document.getElementById("FechaNac").innerHTML = FechaN;

            //ocultamos div de la busqueda del px
            $("#BusquedaPX").hide();
            //mostramos div de la info del px
            $("#InfoPX").show();

            // #region Mostrar botones de Guardar HC ya que ya se buscó el px
            $("#Btn_Save1").css("display", "");
            $("#Btn_Save2").css("display", "");
            $("#Btn_Save3").css("display", "");
            $("#Btn_Save4").css("display", "");
            $("#Btn_Save5").css("display", "");
            $("#Btn_Save6").css("display", "");
            $("#Btn_Save7").css("display", "");
            $("#Btn_Save9").css("display", "");
            $("#Btn_Save11").css("display", "");
            $("#Btn_Save15").css("display", "");
            $("#Btn_Save16").css("display", "");
            $("#Btn_Save17").css("display", "");
            // #endregion
        });



    //});

</script>