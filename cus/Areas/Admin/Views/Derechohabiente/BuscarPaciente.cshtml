@using Microsoft.AspNet.Identity
@{
    ViewBag.Title = "Nota de Evolución";
}

<style>
    .modal {
        padding: 0 !important;
    }

    #escalaDolorModal .modal-dialog {
        height: 100%;
        margin-top: 120px;
    }

    .modal-open .main-wrapper {
        filter: none;
    }

    .nav-tabs.nav-tabs-bottom > li {
        margin-bottom: -1px;
        width: 110px;
        max-width: 110px;
        font-size: 10px;
    }

    .user-tabs .nav-tabs > li > a {
        padding: 5px;
    }

    .table-responsive {
        display: none;
    }


    #container {
        position: relative;
        display: inline-block;
        text-align: center;
        color: #EEAA7B;
        font-family: 'Montserrat', sans-serif;
    }

    #scale {
        transform: rotateX(180deg);
        stroke-width: 50;
        fill: none;
    }

    #YAS {
        stroke: #29ce58;
        stroke-dasharray: 471, 943;
    }

    #Yeah {
        stroke: #87d19c;
        stroke-dasharray: 393, 943;
    }

    #Mmkay {
        stroke: #ffd651;
        stroke-dasharray: 315, 943;
    }

    #Ouch {
        stroke: #ef961a;
        stroke-dasharray: 237, 943;
    }

    #Owwwww {
        stroke: #f26d0e;
        stroke-dasharray: 159, 943;
    }

    #AHHHHHHH {
        stroke: #ce2d2d;
        stroke-dasharray: 81, 943;
    }

    #needle {
        fill: #66B9BF;
    }

    .faces {
        position: absolute;
        width: 20%;
        height: 20%;
        top: 37%;
        left: 40%;
    }

        .faces #YAS, .faces #Yeah, .faces #Mmkay, .faces #Owwwww, .faces #AHHHHHHH {
            visibility: hidden;
        }

    #slider, #level {
        position: absolute;
    }

    h1 {
        position: absolute;
        top: 60%;
        left: 0;
        margin: auto;
        right: 0;
        font-size: 1.5em;
    }

    #slider {
        cursor: pointer;
        left: 0;
        margin: auto;
        right: 0;
        top: 70%;
        width: 50%;
        -webkit-appearance: none;
        border-radius: 10px;
        height: 15px;
        background-color: #66B9BF;
    }

        #slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 15px;
            border-radius: 3px;
            background: #ffffff;
            cursor: pointer;
        }

        #slider:focus {
            outline: none;
        }

    #level {
        color: black;
        font-size: 15pt;
        font-weight: bold;
        top: 75%;
        width: 50%;
        left: 25%;
        visibility: hidden;
        font-size: .9em;
        color: #EEAA7B;
    }


    .gradient-blur {
        position: fixed;
        z-index: 5;
        inset: auto 0 0 0;
        height: 65%;
        pointer-events: none;
    }

        .gradient-blur > div,
        .gradient-blur::before,
        .gradient-blur::after {
            position: absolute;
            inset: 0;
        }

        .gradient-blur::before {
            content: "";
            z-index: 1;
            -webkit-backdrop-filter: blur(0.5px);
            backdrop-filter: blur(0.5px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, black 12.5%, black 25%, rgba(0, 0, 0, 0) 37.5%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 0%, black 12.5%, black 25%, rgba(0, 0, 0, 0) 37.5%);
        }

        .gradient-blur > div:nth-of-type(1) {
            z-index: 2;
            -webkit-backdrop-filter: blur(1px);
            backdrop-filter: blur(1px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 12.5%, black 25%, black 37.5%, rgba(0, 0, 0, 0) 50%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 12.5%, black 25%, black 37.5%, rgba(0, 0, 0, 0) 50%);
        }

        .gradient-blur > div:nth-of-type(2) {
            z-index: 3;
            -webkit-backdrop-filter: blur(2px);
            backdrop-filter: blur(2px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 25%, black 37.5%, black 50%, rgba(0, 0, 0, 0) 62.5%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 25%, black 37.5%, black 50%, rgba(0, 0, 0, 0) 62.5%);
        }

        .gradient-blur > div:nth-of-type(3) {
            z-index: 4;
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 37.5%, black 50%, black 62.5%, rgba(0, 0, 0, 0) 75%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 37.5%, black 50%, black 62.5%, rgba(0, 0, 0, 0) 75%);
        }

        .gradient-blur > div:nth-of-type(4) {
            z-index: 5;
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 50%, black 62.5%, black 75%, rgba(0, 0, 0, 0) 87.5%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 50%, black 62.5%, black 75%, rgba(0, 0, 0, 0) 87.5%);
        }

        .gradient-blur > div:nth-of-type(5) {
            z-index: 6;
            -webkit-backdrop-filter: blur(16px);
            backdrop-filter: blur(16px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 62.5%, black 75%, black 87.5%, rgba(0, 0, 0, 0) 100%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 62.5%, black 75%, black 87.5%, rgba(0, 0, 0, 0) 100%);
        }

        .gradient-blur > div:nth-of-type(6) {
            z-index: 7;
            -webkit-backdrop-filter: blur(32px);
            backdrop-filter: blur(32px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 75%, black 87.5%, black 100%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 75%, black 87.5%, black 100%);
        }

        .gradient-blur::after {
            content: "";
            z-index: 8;
            -webkit-backdrop-filter: blur(64px);
            backdrop-filter: blur(64px);
            -webkit-mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 87.5%, black 100%);
            mask: linear-gradient(to bottom, rgba(0, 0, 0, 0) 87.5%, black 100%);
        }

    body {
        height: 100vh;
        overflow: hidden;
    }

    .flecha {
        width: 10px;
    }

    .btn-buscar {
        background-color: #20c0f3;
        color: white !important;
        width: 8%;
    }

        .btn-buscar:hover {
            background-color: #20c0f3 !important;
            color: white !important;
        }

    .btnbuscapac {
        width: 20px;
        -webkit-filter: invert(100%);
        filter: invert(100%);
    }

    .profile-header {
        padding-left: 0px;
        margin-bottom: 20px;
    }
</style>

<div class="page-wrapper">
    <div class="content container-fluid">

        <div class="page-header">
            <div class="row">
                <div class="col-sm-12">
                    @*<ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="@Url.Action(" Index", "Admin" )">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="@Url.Action(" Index", "HistoriaClinica" )">Historia Clínica</a></li>
                        </ul>*@
                </div>
            </div>
        </div>

        <div class="row">

            <div class="col-sm-12 p-0" id="InfoPX">
                <div class="profile-header">
                    <div class="row align-items-center">
                        <div class="col-auto profile-image">
                            <a href="#">
                                @*<img class="rounded-circle" alt="User Image" src="~/Content/assets/img/profiles/avatar-04.jpg">*@
                            </a>
                        </div>
                        <div class="col ml-md-n2 profile-user-info">
                            <h10 style="font-weight:bold;">Nombre: </h10>
                            <a id="Nombre"></a><br />
                            <h10 style="font-weight:bold;">Expediente: </h10>
                            <a id="Exp"></a><br />
                            <h10 style="font-weight:bold;">Unidad de Afiliación: </h10>
                            <a id="UniAfil"></a><br />
                            <h10 style="font-weight:bold;">Edad: </h10>
                            <a id="Edad"></a><br />
                            <h10 style="font-weight:bold;">Sexo: </h10>
                            <a id="Sexo"></a><br />
                            <h10 style="font-weight:bold;">Fecha Nac.: </h10>
                            <a id="FechaNac"></a>
                        </div>
                        <div class="col-4">
                            <a href="" id="consultar" class="btn btn-primary">Consultar</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-12 p-0" id="BusquedaPX">
                <div class="row">
                    <div class="col-md-12">
                        <h4>Busque al px.</h4>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <input type="text" class="form-control BuscarPX" id="NombrePX" placeholder="Nombre PX" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <input type="text" class="form-control BuscarPX" id="ExpedientePX" placeholder="Expediente PX" required>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-primary" onclick="BtnBuscarPX()">Buscar</button>
                    </div>
                </div>
                <div>
                    <div class="table-responsive">
                        <table id="TblPaciente" class="datatable table table-stripped">
                            <thead>
                                <tr>
                                    <th style="text-align:center">
                                        Nombre
                                    </th>
                                    <th style="text-align:center">
                                        Primer Apellido
                                    </th>
                                    <th style="text-align:center">
                                        Segundo Apellido
                                    </th>
                                    <th style="text-align:center">
                                        Unidad de Afiliacion
                                    </th>
                                    <th style="text-align:center">
                                        Expediente
                                    </th>
                                    <th style="width:5px">Seleccionar</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>



<script src="~/Areas/Admin/assets/js/jquery-3.2.1.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/gsap/2.1.0/TweenMax.min.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>


<script>
    // Initialization Area
    var painArray = ["YAS", "Yeah", "Mmkay", "Ouch", "Owwwww", "AHHHHHHH"];
    //var painArray = ["Sin Dolor", "Duele un poco", "Duele un poco más", "Duele aún más", "Duele mucho", "El peor dolor"];
    var pain = {}
    for (var i = 0; i < painArray.length; i++) {
        pain[i] = painArray[i];
    }
    var needle = $("#needle");
    var prevFace = ".faces #Ouch";
    var slider = document.getElementById("slider");

    var level = document.getElementById("level");
    //alert(slider.value);
    level.innerHTML = slider.value;

    function findPainLevel(value) {
        var painLevel = Math.floor(value / (Math.round(100 / 6)));
        return painLevel;
    }

    function moveGauge(input) {
        var value = Number(input);
        var maxScale = 943;
        var minScale = 471;
        var maxDegree = 85;
        var scaledValue = ((maxScale - minScale) / 100) * value + minScale;
        var midScale = (maxScale - minScale) / 2 + minScale; // mid is actually rotate 0

        if (scaledValue <= midScale) {
            var rotate = 1;
        }
        else {
            var rotate = -1;
        }

        var scalePerDegree = (midScale - minScale) / maxDegree;
        var rotateValue = (midScale - scaledValue) / scalePerDegree;
        var rotation = rotate * rotateValue;
        //console.log(input,scaledValue ,midScale, rotate, rotation);
        var tl = new TimelineLite();
        tl.to(needle, 1, { rotation: rotateValue });
    }

    function morphFace(painLevel) {
        var mouthExpression;
        mouthExpression = "#mouth_" + painLevel;
        var facialExpression = ".faces #" + pain[painLevel];
        var tl = new TimelineMax();
        tl.to("#mouth_3", 1, { morphSVG: mouthExpression });
        $(prevFace).css("visibility", "hidden");
        $(facialExpression).css("visibility", "visible");
        prevFace = facialExpression;

    }

    slider.oninput = function () {
        $(level).css("visibility", "visible");
        var currentLevel = this.value;
        var painLevel = findPainLevel(currentLevel);
        moveGauge(currentLevel);
        //alert(pain[painLevel]);

        //var painArray = ["YAS", "Yeah", "Mmkay", "Ouch", "Owwwww", "AHHHHHHH"];
        //var painArray = ["Sin Dolor", "Duele un poco", "Duele un poco más", "Duele aún más", "Duele mucho", "El peor dolor"];

        switch (pain[painLevel]) {
            case "YAS":
                level.innerHTML = "Sin Dolor";
                break;
            case "Yeah":
                level.innerHTML = "Duele un poco";
                break;
            case "Mmkay":
                level.innerHTML = "Duele un poco más";
                break;
            case "Ouch":
                level.innerHTML = "Duele aún más";
                break;
            case "Owwwww":
                level.innerHTML = "Duele mucho";
                break;
            default:
                level.innerHTML = "El peor dolor";
        }

        morphFace(painLevel);

    }
</script>

<script>

    //$(document).ready(function () {
        $("#InfoPX").hide();

        //Si dan click en Enter en los inputs de Nombre/Expediente
        $('.BuscarPX').on("keypress", function (e) {
            if (e.keyCode == 13) {
                FuncionBuscarPX();
                return false;
            }
        });

        //Si dan click en el botón de Buscar
        function BtnBuscarPX() {
            //alert('adad');
            FuncionBuscarPX();
        };

        function FuncionBuscarPX() {
            var NombrePX = $("#NombrePX").val();
            var ExpedientePX = $("#ExpedientePX").val();
            $('.table-responsive').css('display','block');

            Swal.fire({
                title: 'Cargando... Espere por favor',
                timer: 1000,
                timerProgressBar: true,
            });

            $.ajax({
                url: '@Url.Action("BuscarPaciente", "Derechohabiente")',
                method: 'POST',
                dataType: 'json',
                data: {
                    NombrePX: NombrePX,
                    ExpedientePX: ExpedientePX
                },
                success: function (data) {
                    if (data.MENSAJE.substring(0, 6) == "Succe:") {
                        LlenaTablaPX(data.PACIENTES);
                    }
                    if (data.MENSAJE.substring(0, 6) == "Error:") {
                        Swal.fire({
                            icon: 'error',
                            title: '¡Error!',
                            text: data.MENSAJE.substring(7),
                        });
                    }
                },
                error: function (ex) {
                    Swal.fire({
                        icon: 'error',
                        title: '¡Error!',
                    });
                }
            });

        };

        function LlenaTablaPX(PX) {
            var table = $('#TblPaciente').DataTable();
            table.destroy();

            table = $('#TblPaciente').DataTable({
                responsive: true,
                searching: false,
                info: true,
                deferRender: true,
                scroller: false,
                scrollColapse: true,
                paging: false,
                lengthChange: false,
                language: {
                    "zeroRecords": "No se encontraron PX",
                    "info": "",
                    "search": "",
                    "infoEmpty": "",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior",
                    },
                    "select": {
                        "rows": " %d filas seleccionadas"
                    },
                },
                data: PX,
                columns: [
                    { 'data': 'Nombre', className: "text-center" },
                    { 'data': 'PrimerApellido', className: "text-center" },
                    { 'data': 'SegundoApellido', className: "text-center" },
                    {
                        "data": "UnidadAfiliacion", className: "text-center", render: function (data, type, row) {
                            if (row.UnidadAfiliacion == 1) {
                                return '<h8 style="color:black; ">Unidad habitacional I.</h8>';
                            }
                            if (row.UnidadAfiliacion == 2) {
                                return '<h8 style="color:black; ">Módulo dental Apodaca</h8>';
                            }
                            if (row.UnidadAfiliacion == 3) {
                                return '<h8 style="color:black; ">Pueblo Nuevo</h8>';
                            }
                            if (row.UnidadAfiliacion == 4) {
                                return '<h8 style="color:black; ">Vicente Guerrero</h8>';
                            }
                            if (row.UnidadAfiliacion == 5) {
                                return '<h8 style="color:black; ">San Rafael</h8>';
                            }
                            if (row.UnidadAfiliacion == 6) {
                                return '<h8 style="color:black; ">21 de enero</h8>';
                            }
                            if (row.UnidadAfiliacion == 7) {
                                return '<h8 style="color:black; ">Clínica de atención int.</h8>';
                            }
                            if (row.UnidadAfiliacion == 8) {
                                return '<h8 style="color:black; ">Módulo dental Guadalupe</h8>';
                            }
                            if (row.UnidadAfiliacion == 9) {
                                return '<h8 style="color:black; ">Ciénega de Flores</h8>';
                            }
                        }
                    },
                    { 'data': 'Expediente', className: "text-center" },
                    {
                        "className": 'text-center',
                        "orderable": false,
                        "data": null,
                        "defaultContent": '<button title="Seleccionar px" id="VerDetalle" class="btn btn-success fa fa-check" data-toggle="modal" ></button>',
                        "target": -2
                    }
                ]
            });
        }


        $('#TblPaciente tbody').on('click', '#VerDetalle', function () {
            var tr = $(this).closest('tr');
            row = $('#TblPaciente').DataTable().row(tr);

            var Nombre = row.data().Nombre;
            var PrimerA = row.data().PrimerApellido;
            var SegundoA = row.data().SegundoApellido;
            var UnidadAfiliacion = "";

            if (row.data().UnidadAfiliacion == 1) {
                UnidadAfiliacion = "Unidad habitacional I";
            }
            if (row.data().UnidadAfiliacion == 2) {
                UnidadAfiliacion = "Módulo dental Apodaca";
            }
            if (row.data().UnidadAfiliacion == 3) {
                UnidadAfiliacion = "Pueblo Nuevo";
            }
            if (row.data().UnidadAfiliacion == 4) {
                UnidadAfiliacion = "Vicente Guerrero";
            }
            if (row.data().UnidadAfiliacion == 5) {
                UnidadAfiliacion = "San Rafael";
            }
            if (row.data().UnidadAfiliacion == 6) {
                UnidadAfiliacion = "21 de enero";
            }
            if (row.data().UnidadAfiliacion == 7) {
                UnidadAfiliacion = "Clínica de atención int.";
            }
            if (row.data().UnidadAfiliacion == 8) {
                UnidadAfiliacion = "Módulo dental Guadalupe";
            }
            if (row.data().UnidadAfiliacion == 9) {
                UnidadAfiliacion = "Ciénega de Flores";
            }


            var Exp = row.data().Expediente;
            var Edad = row.data().Edad;
            var Sexo = row.data().Sexo;
            var FechaN = row.data().FechaNacimiento;

            //console.log(FechaN);
            //Dividir fecha de nacimiento
            var splitFechaN = FechaN.split('/');
            const anioNacimiento = parseInt(splitFechaN[2]);
            const mesNacimiento = parseInt(splitFechaN[1]);
            const diaNacimiento = parseInt(splitFechaN[0]);

            // Obtiene la fecha actual
            const fechaActual = new Date();

            // Obtiene el año, mes y día actual
            const anioActual = fechaActual.getFullYear();
            const mesActual = fechaActual.getMonth() + 1; // Los meses en JavaScript van de 0 a 11
            const diaActual = fechaActual.getDate();

            // Calcula la edad
            let edad = anioActual - anioNacimiento;
            let edadMeses = mesActual - mesNacimiento;

            // Verifica si aún no ha llegado el cumpleaños de este año
            if (mesActual < mesNacimiento || (mesActual === mesNacimiento && diaActual < diaNacimiento)) {
                edad--;
            }

            //alert(edad + mesActual);

            document.getElementById("Nombre").innerHTML = Nombre + " " + PrimerA + " " + SegundoA;
            document.getElementById("Exp").innerHTML = Exp;
            document.getElementById("UniAfil").innerHTML = UnidadAfiliacion;
            document.getElementById("Edad").innerHTML = edad + ' años ' + edadMeses + ' meses';
            document.getElementById("Sexo").innerHTML = Sexo;
            document.getElementById("FechaNac").innerHTML = FechaN;

            $('#consultar').attr('href', '@Url.Action("Create", "NotaEvolucion")?expediente=' + Exp)


            //ocultamos div de la busqueda del px
            $("#BusquedaPX").hide();
            //mostramos div de la info del px
            $("#InfoPX").show();

            //Quitar el blur de la nota
            $('.gradient-blur').hide();
            //Regresar el height de el body
            $('body').css('height', 'auto');
            $('body').css('overflow', 'auto');

            $("#numexp").val(Exp);

        });



    //});

</script>